# Make sure key variables are correct types
long_data <- long_data %>%
mutate(
depth = as.numeric(depth),
penetration_resistance = as.numeric(penetration_resistance),
treatment = factor(treatment),
location = factor(location)
)
summary_profiles <- summary_profiles %>%
mutate(
depth = as.numeric(depth),
mean = as.numeric(mean),
sem = as.numeric(sem),
treatment = factor(treatment),
location = factor(location)
)
# ---- Global ggplot theme (thesis style) ----
theme_set(
theme_minimal(base_size = 14) +
theme(
panel.grid.minor = element_blank(),
legend.position = "top"
)
)
summary_profiles <- long_data %>%
mutate(
depth = as.numeric(depth),
penetration_resistance = as.numeric(penetration_resistance)
) %>%
group_by(id, treatment, location, depth) %>%
summarise(
mean  = mean(penetration_resistance, na.rm = TRUE),
stdev = sd(penetration_resistance, na.rm = TRUE),
n     = sum(!is.na(penetration_resistance)),
sem   = stdev / sqrt(n),
.groups = "drop"
) %>%
arrange(treatment, id, depth)
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_path(linewidth = 1, alpha = 0.8) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
summary_profiles <- long_data %>%
mutate(
depth = as.numeric(depth),
penetration_resistance = as.numeric(penetration_resistance)
) %>%
group_by(id, treatment, location, depth) %>%
summarise(
mean  = mean(penetration_resistance, na.rm = TRUE),
stdev = sd(penetration_resistance, na.rm = TRUE),
n     = sum(!is.na(penetration_resistance)),
sem   = stdev / sqrt(n),
.groups = "drop"
) %>%
arrange(treatment, id, depth)
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_errorbarh(
aes(xmin = mean - sem, xmax = mean + sem),
height = 0.8,   # controls vertical size of the bar
alpha = 0.6
) +
geom_path(linewidth = 1, alpha = 0.8) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
summary_profiles_trt <- summary_profiles %>%
group_by(treatment, location, depth) %>%
summarise(
mean = mean(mean, na.rm = TRUE),
sem  = sd(mean, na.rm = TRUE) / sqrt(n()),
.groups = "drop"
)
p_profiles <- ggplot() +
# Ribbon (SEM envelope)
geom_ribbon(
data = summary_profiles_trt,
aes(
y = depth,
xmin = mean - sem,
xmax = mean + sem,
fill = factor(treatment)
),
alpha = 0.25
) +
# Individual profiles
geom_path(
data = summary_profiles,
aes(
x = mean,
y = depth,
colour = factor(treatment),
group = interaction(treatment, id)
),
linewidth = 0.8,
alpha = 0.6
) +
# Treatment mean line
geom_path(
data = summary_profiles_trt,
aes(
x = mean,
y = depth,
colour = factor(treatment),
group = treatment
),
linewidth = 1.4
) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
fill = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
summary_profiles_trt <- summary_profiles %>%
group_by(treatment, location, depth) %>%
summarise(
mean = mean(mean, na.rm = TRUE),
n_id = sum(!is.na(mean)),
sd_id = sd(mean, na.rm = TRUE),
sem  = ifelse(n_id > 1, sd_id / sqrt(n_id), NA_real_),
.groups = "drop"
) %>%
filter(!is.na(mean), !is.na(sem))
p_profiles <- ggplot() +
geom_ribbon(
data = summary_profiles_trt,
aes(
y = depth,
xmin = mean - sem,
xmax = mean + sem,
fill = factor(treatment),
group = treatment
),
alpha = 0.25
) +
geom_path(
data = summary_profiles,
aes(
x = mean,
y = depth,
colour = factor(treatment),
group = interaction(treatment, id)
),
linewidth = 0.8,
alpha = 0.6
) +
geom_path(
data = summary_profiles_trt,
aes(
x = mean,
y = depth,
colour = factor(treatment),
group = treatment
),
linewidth = 1.4
) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
fill = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
ggsave(file.path(plot_dir, "figure_01_mean_profiles.png"),
plot = p_profiles,
height = 6, width = 8, dpi = 300)
summary_profiles_trt %>%
group_by(treatment, location) %>%
summarise(
n_depth = n(),
n_sem_ok = sum(!is.na(sem)),
.groups = "drop"
)
View(summary_profiles_trt)
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_path(linewidth = 1, alpha = 0.8) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
summary_profiles_trt <- summary_profiles %>%
group_by(treatment, location, depth) %>%
summarise(
mean = mean(mean, na.rm = TRUE),
n_id = sum(!is.na(mean)),
sd_id = sd(mean, na.rm = TRUE),
sem  = ifelse(n_id > 1, sd_id / sqrt(n_id), 0),
.groups = "drop"
) %>%
filter(!is.na(mean))
p_profiles <- ggplot() +
geom_ribbon(
data = summary_profiles_trt,
aes(
y = depth,
xmin = mean - sem,
xmax = mean + sem,
fill = factor(treatment),
group = treatment
),
alpha = 0.25
) +
geom_path(
data = summary_profiles,
aes(
x = mean,
y = depth,
colour = factor(treatment),
group = interaction(treatment, id)
),
linewidth = 0.8,
alpha = 0.6
) +
geom_path(
data = summary_profiles_trt,
aes(
x = mean,
y = depth,
colour = factor(treatment),
group = treatment
),
linewidth = 1.4
) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
fill = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_errorbarh(
aes(xmin = mean - sem, xmax = mean + sem),
height = 0.8,   # controls vertical size of the bar
alpha = 0.6
) +
geom_path(linewidth = 1, alpha = 0.8) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_errorbarh(
aes(xmin = mean - sem, xmax = mean + sem),
height = 0.8,   # controls vertical size of the bar
alpha = 0.6
) +
geom_path(linewidth = 1, alpha = 0.5) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_errorbarh(
aes(xmin = mean - sem, xmax = mean + sem),
height = 0.8,
alpha = 0.3   # error bars more transparent
) +
geom_path(
linewidth = 1,
alpha = 0.8   # mean lines more visible
) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_errorbarh(
aes(xmin = mean - sem, xmax = mean + sem),
height = 0.8,
alpha = 0.3   # error bars more transparent
) +
geom_path(
linewidth = 1,
alpha = 0.1   # mean lines more visible
) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_errorbarh(
aes(xmin = mean - sem, xmax = mean + sem),
height = 0.8,
alpha = 0.3   # error bars more transparent
) +
geom_path(
linewidth = 1,
alpha = 1   # mean lines more visible
) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_bw()
p_profiles
ggsave(file.path(plot_dir, "figure_01_mean_profiles.png"),
plot = p_profiles,
height = 5, width = 8, dpi = 300)
long_data <- long_data %>%
mutate(treatment = as.integer(as.character(treatment)))
local_coords <- local_coords %>%
mutate(treatment = as.integer(treatment))
long_data <- long_data %>%
left_join(
local_coords,
by = c("treatment", "replicate_number")
)
long_data %>%
summarise(
n_missing_x = sum(is.na(local_x)),
n_missing_y = sum(is.na(local_y))
)
library(dplyr)
library(plotly)
plot_id <- 1
id_i <- 26012235
dfp_local <- long_data %>%
filter(id == id_i, plot_number == plot_id) %>%
mutate(
z = -depth
)
p3d_local <- plot_ly(
dfp_local,
x = ~local_x, y = ~local_y, z = ~z,
color = ~penetration_resistance,
split = ~replicate_number,
type = "scatter3d",
mode = "lines",
line = list(width = 5),
text = ~paste(
"Name:", name,
"<br>Rep:", replicate_number,
"<br>Depth:", depth,
"<br>PR:", penetration_resistance
)
) %>%
layout(
showlegend = FALSE,   # <- THIS removes the line legend
scene = list(
xaxis = list(title = "Local X", range = c(0, 500)),
yaxis = list(title = "Local Y", range = c(0, 500)),
zaxis = list(title = "Depth (cm)"),
aspectmode = "manual",
aspectratio = list(x = 1, y = 1, z = 0.5)
),
title = paste0("3D penetration resistance (local coords) â€“ Plot ", plot_id, " | ID ", id_i)
)
p3d_local
pr_limits <- quantile(
long_data$penetration_resistance,
c(0.02, 0.98),
na.rm = TRUE
)
pr_limits <- c(0, pr_limits[2])  # force min = 0
res <- analyze_plot_3d_kriging(long_data, id_i = 26012232,
save_dir = file.path(DATA_ROOT, "figures"), pr_limits = pr_limits)
res$pred_plot
source(file = "R/read_pen_file.R")
# ---- Packages + functions ----
source("analyses/01_packages.R")
source("R/dms_to_decimal.R")
source("R/to_long.R")
source(file = "R/read_pen_file.R")
source("config.R")
stopifnot(dir.exists(DATA_ROOT))
txt_dir   <- file.path(DATA_ROOT, "txt")
info_dir  <- file.path(DATA_ROOT, "info")
proc_dir  <- file.path(DATA_ROOT, "processed")
long_dir  <- file.path(proc_dir, "long_format_data")
sum_dir   <- file.path(proc_dir, "summary_profiles")
dir.create(long_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(sum_dir,  recursive = TRUE, showWarnings = FALSE)
# ---- Inputs ----
treatment_info <- read.csv(file.path(info_dir, "treatment_info.csv")) %>%
mutate(id = as.integer(id))
# helper: id from filename
id_from_file <- function(path) as.integer(tools::file_path_sans_ext(basename(path)))
# small helper: provide fallback if missing (like %||% in rlang)
`%||%` <- function(x, y) if (!is.null(x) && length(x) > 0 && !is.na(x)) x else y
# ---- Read all files ----
txt_files <- list.files(txt_dir, pattern = "\\.txt$", full.names = TRUE)
parsed <- map(txt_files, read_pen_file)
# ---- Combine wide data (all pens/replicates) ----
wide_all <- map_dfr(parsed, "data")
# ---- 1) Meta info (one row per pen/replicate) ----
coord_pat <- "^([NS])(\\d+)\\s+(\\d+\\.?\\d*)\\s+([WE])(\\d+)\\s+(\\d+\\.?\\d*)$"
meta_info <- wide_all %>%
select(id, treatment, location, name, coordinates, project, username, date,
pens_per_plot, nr_of_pens_done, cone_type, pen_speed, depth_unit, pressure_unit) %>%
distinct() %>%
mutate(
.m = str_match(coordinates, coord_pat),
lat_dir = .m[, 2],
lat_deg = as.numeric(.m[, 3]),
lat_min = as.numeric(.m[, 4]),
lon_dir = .m[, 5],
lon_deg = as.numeric(.m[, 6]),
lon_min = as.numeric(.m[, 7]),
latitude  = mapply(dms_to_decimal, lat_deg, lat_min, lat_dir),
longitude = mapply(dms_to_decimal, lon_deg, lon_min, lon_dir),
.m = NULL,
plot_number      = str_match(name, "^PLOT-(\\d{3})\\.")[, 2],
replicate_number = str_match(name, "^PLOT-\\d{3}\\.(\\d+)")[, 2]
)
source("~/git/SoilPenRes/analyses/02_data_pipeline.R")
getwd()
renv::init()
renv::status()
