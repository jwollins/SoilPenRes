y = "Local Y"
) +
theme_minimal()
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "viridis", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme_minimal()
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "inferno", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme_minimal()
depths <- c(10, 20, 30, 40, 60, 70, 80)
slice_multi <- as.data.frame(kriged_3d) %>%
mutate(depth = round(z_scaled / z_scale)) %>%
filter(depth %in% depths)
library(viridis)
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "inferno", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme_minimal()
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "inferno", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme_minimal() +
facet_wrap(
~ depth,
ncol = 3,
labeller = labeller(
depth = function(x) paste0("Depth = ", x, " cm")
)
)
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "inferno", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme(
strip.text = element_text(face = "bold"),
strip.background = element_rect(fill = "grey95", colour = NA)
) +
theme_minimal() +
facet_wrap(
~ depth,
ncol = 3,
labeller = labeller(
depth = function(x) paste0("Depth = ", x, " cm")
)
)
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "inferno", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme_minimal() +
facet_wrap(
~ depth,
ncol = 3,
labeller = labeller(
depth = function(x) paste0("Depth = ", x, " cm")
)
) +
theme(
strip.text = element_text(face = "bold"),
strip.background = element_rect(fill = "grey95", colour = NA)
)
summary_profiles <- long_data %>%
mutate(
depth = as.numeric(depth),
penetration_resistance = as.numeric(penetration_resistance)
) %>%
group_by(id, treatment, location, depth) %>%
summarise(
mean  = mean(penetration_resistance, na.rm = TRUE),
stdev = sd(penetration_resistance, na.rm = TRUE),
n     = sum(!is.na(penetration_resistance)),
sem   = stdev / sqrt(n),
.groups = "drop"
) %>%
arrange(treatment, id, depth)
p_profiles <- ggplot(
summary_profiles,
aes(x = mean, y = depth,
colour = factor(treatment),
group = interaction(treatment, id))
) +
geom_path(linewidth = 1, alpha = 0.8) +
scale_y_reverse() +
facet_wrap(~ location) +
labs(
x = "Penetration resistance (MPa)",
y = "Depth (cm)",
colour = "Treatment",
title = "Mean penetration resistance profiles by location"
) +
theme_minimal()
p_profiles
ggsave(file.path(plot_dir, "figure_01_mean_profiles.png"),
plot = p_profiles,
height = 6, width = 8, dpi = 300)
glimpse(long_data)
glimpse(local_coords)
long_data <- long_data %>%
mutate(treatment = as.integer(as.character(treatment)))
local_coords <- local_coords %>%
mutate(treatment = as.integer(treatment))
long_data <- long_data %>%
left_join(
local_coords,
by = c("treatment", "replicate_number")
)
long_data %>%
summarise(
n_missing_x = sum(is.na(local_x)),
n_missing_y = sum(is.na(local_y))
)
library(dplyr)
library(plotly)
plot_id <- 1
id_i <- 26012235
dfp_local <- long_data %>%
filter(id == id_i, plot_number == plot_id) %>%
mutate(
z = -depth
)
p3d_local <- plot_ly(
dfp_local,
x = ~local_x, y = ~local_y, z = ~z,
color = ~penetration_resistance,
split = ~replicate_number,
type = "scatter3d",
mode = "lines",
line = list(width = 5),
text = ~paste(
"Name:", name,
"<br>Rep:", replicate_number,
"<br>Depth:", depth,
"<br>PR:", penetration_resistance
)
) %>%
layout(
showlegend = FALSE,   # <- THIS removes the line legend
scene = list(
xaxis = list(title = "Local X", range = c(0, 500)),
yaxis = list(title = "Local Y", range = c(0, 500)),
zaxis = list(title = "Depth (cm)"),
aspectmode = "manual",
aspectratio = list(x = 1, y = 1, z = 0.5)
),
title = paste0("3D penetration resistance (local coords) – Plot ", plot_id, " | ID ", id_i)
)
p3d_local
glimpse(long_data)
glimpse(local_coords)
long_data <- long_data %>%
mutate(treatment = as.integer(as.character(treatment)))
local_coords <- local_coords %>%
mutate(treatment = as.integer(treatment))
long_data <- long_data %>%
left_join(
local_coords,
by = c("treatment", "replicate_number")
)
long_data %>%
summarise(
n_missing_x = sum(is.na(local_x)),
n_missing_y = sum(is.na(local_y))
)
library(dplyr)
library(plotly)
plot_id <- 1
id_i <- 26012235
dfp_local <- long_data %>%
filter(id == id_i, plot_number == plot_id) %>%
mutate(
z = -depth
)
p3d_local <- plot_ly(
dfp_local,
x = ~local_x, y = ~local_y, z = ~z,
color = ~penetration_resistance,
split = ~replicate_number,
type = "scatter3d",
mode = "lines",
line = list(width = 5),
text = ~paste(
"Name:", name,
"<br>Rep:", replicate_number,
"<br>Depth:", depth,
"<br>PR:", penetration_resistance
)
) %>%
layout(
showlegend = FALSE,   # <- THIS removes the line legend
scene = list(
xaxis = list(title = "Local X", range = c(0, 500)),
yaxis = list(title = "Local Y", range = c(0, 500)),
zaxis = list(title = "Depth (cm)"),
aspectmode = "manual",
aspectratio = list(x = 1, y = 1, z = 0.5)
),
title = paste0("3D penetration resistance (local coords) – Plot ", plot_id, " | ID ", id_i)
)
p3d_local
library(akima)
# grid
xg <- seq(0, 500, length.out = 50)
yg <- seq(0, 500, length.out = 50)
depth_i <- 40  # pick a depth
df_d <- long_data %>%
filter(id == id_i, depth == depth_i)
interp2d <- with(df_d,
interp(x = local_x,
y = local_y,
z = penetration_resistance,
xo = xg,
yo = yg,
linear = TRUE)
)
filled.contour(
interp2d$x,
interp2d$y,
interp2d$z,
color.palette = viridis::viridis,
xlab = "X (cm)",
ylab = "Y (cm)",
main = paste("PR at", depth_i, "cm")
)
library(fields)
dfp <- long_data %>% filter(id == id_i)
# define grid
xg <- seq(0, 500, length.out = 30)
yg <- seq(0, 500, length.out = 30)
zg <- seq(1, 82, length.out = 82)
grid <- expand.grid(
local_x = xg,
local_y = yg,
depth   = zg
)
interp3d <- interp.surface(
obj = list(
x = as.matrix(dfp[, c("local_x", "local_y", "depth")]),
y = dfp$penetration_resistance
),
loc = as.matrix(grid)
)
grid$pr_interp <- interp3d
library(akima)
make_surface <- function(d) {
df_d <- long_data %>% filter(id == id_i, depth == d)
interp(df_d$local_x,
df_d$local_y,
df_d$penetration_resistance,
xo = seq(0, 500, length = 50),
yo = seq(0, 500, length = 50))
}
cube <- lapply(1:82, make_surface)
depths <- c(10, 20, 30, 40)
slice_df_all <- purrr::map_dfr(depths, function(d) {
s <- cube[[d]]
expand.grid(local_x = s$x, local_y = s$y) %>%
mutate(
penetration_resistance = as.vector(s$z),
depth = d
)
})
ggplot(slice_df_all, aes(local_x, local_y, fill = penetration_resistance)) +
geom_raster() +
coord_equal() +
facet_wrap(~ depth) +
labs(title = "Penetration resistance slices", x = "Local X", y = "Local Y") +
theme_minimal()
library(plotly)
# build a 3D point cloud from the interpolated cube
grid_pts <- purrr::imap_dfr(cube, function(s, d_chr) {
d <- as.integer(d_chr)
df <- expand.grid(local_x = s$x, local_y = s$y)
df$pr <- as.vector(s$z)
df$depth <- d
df
})
# optionally thin the grid so plotly isn't huge
grid_pts_thin <- grid_pts %>% sample_n(20000)
plot_ly(
grid_pts_thin,
x = ~local_x, y = ~local_y, z = ~(-depth),
color = ~pr,
type = "scatter3d",
mode = "markers",
marker = list(size = 1)
) %>%
layout(scene = list(
xaxis = list(title = "Local X", range = c(0, 500)),
yaxis = list(title = "Local Y", range = c(0, 500)),
zaxis = list(title = "Depth (cm)")
))
depths <- c(10, 20, 30, 40)
slice_df_all <- purrr::map_dfr(depths, function(d) {
s <- cube[[d]]
expand.grid(local_x = s$x, local_y = s$y) %>%
mutate(
penetration_resistance = as.vector(s$z),
depth = d
)
})
ggplot(slice_df_all, aes(local_x, local_y, fill = penetration_resistance)) +
geom_raster() +
coord_equal() +
facet_wrap(~ depth) +
labs(title = "Penetration resistance slices", x = "Local X", y = "Local Y") +
theme_minimal()
library(plotly)
# build a 3D point cloud from the interpolated cube
grid_pts <- purrr::imap_dfr(cube, function(s, d_chr) {
d <- as.integer(d_chr)
df <- expand.grid(local_x = s$x, local_y = s$y)
df$pr <- as.vector(s$z)
df$depth <- d
df
})
# optionally thin the grid so plotly isn't huge
grid_pts_thin <- grid_pts %>% sample_n(20000)
plot_ly(
grid_pts_thin,
x = ~local_x, y = ~local_y, z = ~(-depth),
color = ~pr,
type = "scatter3d",
mode = "markers",
marker = list(size = 1)
) %>%
layout(scene = list(
xaxis = list(title = "Local X", range = c(0, 500)),
yaxis = list(title = "Local Y", range = c(0, 500)),
zaxis = list(title = "Depth (cm)")
))
ggplot(slice_multi,
aes(local_x, local_y, fill = var1.pred)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth, ncol = 3) +
scale_fill_viridis_c(option = "inferno", name = "PR (MPa)") +
labs(
title = "3D kriged penetration resistance slices",
x = "Local X",
y = "Local Y"
) +
theme_minimal() +
facet_wrap(
~ depth,
ncol = 3,
labeller = labeller(
depth = function(x) paste0("Depth = ", x, " cm")
)
) +
theme(
strip.text = element_text(face = "bold"),
strip.background = element_rect(fill = "grey95", colour = NA)
)
slice_unc_multi <- slice_unc_multi %>%
mutate(kriging_se = sqrt(var1.var))
depths <- c(10, 20, 30, 40, 60)
slice_unc_multi <- as.data.frame(kriged_3d) %>%
mutate(depth = round(z_scaled / z_scale)) %>%
filter(depth %in% depths)
slice_unc_multi <- slice_unc_multi %>%
mutate(kriging_se = sqrt(var1.var))
ggplot(slice_unc_multi,
aes(local_x, local_y, fill = kriging_se)) +
geom_raster() +
coord_equal(xlim = c(0, 500), ylim = c(0, 500), expand = FALSE) +
facet_wrap(~ depth,
ncol = 3,
labeller = labeller(depth = function(x) paste0(x, " cm"))) +
scale_fill_viridis_c(option = "magma", name = "Kriging SE (MPa)") +
labs(
title = "Standard error of 3D kriged penetration resistance",
x = "Local X",
y = "Local Y"
) +
theme_minimal() +
theme(strip.text = element_text(face = "bold"))
p3d_local
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012233)
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012233)
res$pred_plot
res$se_plot
res$pred_plot
res <- analyze_plot_3d_kriging(long_data, id_i = 26012233)
res$pred_plot
res$se_plot
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012233)
res$pred_plot
res$se_plot
res$pred_plot
res$se_plot
res$pred_plot
res$se_plot
source(file = "R/analyze_plot_3d_kriging.R")
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012233)
res$pred_plot
res$se_plot
ids <- sort(unique(long_data$id))
results <- lapply(ids, function(i) {
analyze_plot_3d_kriging(long_data, id_i = i, save_dir = file.path(DATA_ROOT, "figures"))
})
res <- analyze_plot_3d_kriging(long_data, id_i = 26012235)
res$pred_plot
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012235)
res$pred_plot
res$se_plot
res <- analyze_plot_3d_kriging(long_data, id_i = 26012230)
res$pred_plot
res$se_plot
res <- analyze_plot_3d_kriging(long_data, id_i = 26012231)
res$pred_plot
res$se_plot
res <- analyze_plot_3d_kriging(long_data, id_i = 26012232)
res$pred_plot
res$se_plot
results <- lapply(ids, function(i) {
analyze_plot_3d_kriging(long_data, id_i = i, save_dir = file.path(DATA_ROOT, "figures"))
})
source(file = "R/analyze_plot_3d_kriging.R")
pr_limits <- quantile(
long_data$penetration_resistance,
c(0.02, 0.98),
na.rm = TRUE
)
results <- lapply(ids, function(i) {
analyze_plot_3d_kriging(
long_data,
id_i = i,
pr_limits = pr_limits,
save_dir = file.path(DATA_ROOT, "figures")
)
})
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012232,
save_dir = file.path(DATA_ROOT, "figures"), pr_limits = pr_limits)
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012235,
save_dir = file.path(DATA_ROOT, "figures"), pr_limits = pr_limits)
source(file = "R/analyze_plot_3d_kriging.R")
res <- analyze_plot_3d_kriging(long_data, id_i = 26012235,
save_dir = file.path(DATA_ROOT, "figures"), pr_limits = pr_limits)
res$pred_plot
pr_limits <- c(0, pr_limits[2])  # force min = 0
res <- analyze_plot_3d_kriging(long_data, id_i = 26012235,
save_dir = file.path(DATA_ROOT, "figures"), pr_limits = pr_limits)
res$pred_plot
res <- analyze_plot_3d_kriging(long_data, id_i = 26012232,
save_dir = file.path(DATA_ROOT, "figures"), pr_limits = pr_limits)
res$pred_plot
res$se_plot
pr_limits <- c(0, max(long_data$penetration_resistance, na.rm = TRUE))
se_limits <- c(0, max(sqrt(res$kriged_3d$var1.var), na.rm = TRUE))
results <- lapply(ids, function(i) {
analyze_plot_3d_kriging(
long_data,
id_i = i,
pr_limits = pr_limits,
save_dir = file.path(DATA_ROOT, "figures")
)
})
